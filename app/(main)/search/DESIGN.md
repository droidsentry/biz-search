# 検索システム設計書

## 1. システム概要

### 目的

ビジネス情報検索システムにおいて、Google Custom Search APIを活用した高度な検索機能を提供する。Claudeのプロジェクト管理画面のようなUIを採用し、検索パターンの保存・再利用を可能にすることで、効率的な情報収集を実現する。

### 主要機能

- 検索パターンの作成・保存・管理
- 高度な検索条件の設定（追加キーワード、サイト指定、検索期間など）
- 検索結果の表示とページネーション
- よく使う検索パターンの素早い実行
- API使用状況の追跡と監視

### ClaudeChat風UIの採用理由

- 直感的で使いやすいインターフェース
- 検索パターンのカード表示による視認性の向上
- サイドバーでの素早い検索実行
- 作業効率を最大化するレイアウト

## 2. ページ構成

### 2.1 `/search` - 検索パターン一覧画面

**目的**: 保存された検索パターンを管理し、素早くアクセスできるようにする

**主要機能**:

- 検索パターンのグリッド表示（カード形式）
- パターンの検索・フィルタリング
- 使用頻度順・更新日時順でのソート
- 新規パターン作成へのナビゲーション

**レイアウト**:

```md
┌─────────────────────────────────────────┐
│ ヘッダー                                │
│ ├─ タイトル「カスタム検索」             │
│ └─ 新規検索パターンボタン               │
├─────────────────────────────────────────┤
│ 検索・フィルターバー                    │
├─────────────────────────────────────────┤
│ パターンカードグリッド                  │
│ ┌─────────┐ ┌─────────┐ ┌─────────┐ │
│ │ カード1  │ │ カード2  │ │ カード3  │ │
│ └─────────┘ └─────────┘ └─────────┘ │
└─────────────────────────────────────────┘
```

### 2.2 `/search/create` - 新規検索パターン作成

**目的**: 新しい検索パターンを作成し、初期設定を行う

**主要機能**:

- パターン名と説明の入力
- 基本的な検索条件の設定
- 作成後は検索実行画面へ自動遷移

**フロー**:

1. パターン名と説明を入力
2. 基本的な検索条件を設定（任意）
3. 「作成」ボタンで保存
4. `/search/[searchId]`へリダイレクト

### 2.3 `/search/[searchId]` - 検索実行画面

**目的**: 検索の実行と結果表示、検索条件の調整を効率的に行う

**レイアウト**:

```md
┌─────────────────────────────────────────────────┐
│ ヘッダー（パターン名、編集・削除ボタン）        │
├───────────────────────┬─────────────────────────┤
│                       │ 検索フォーム（コンパクト）│
│                       ├─────────────────────────┤
│   検索結果一覧        │ 保存パターン一覧        │
│   （メイン領域）      │ ┌───────────────────┐ │
│                       │ │ パターンカード1    │ │
│                       │ └───────────────────┘ │
│                       │ ┌───────────────────┐ │
│                       │ │ パターンカード2    │ │
│                       │ └───────────────────┘ │
└───────────────────────┴─────────────────────────┘
```

**主要機能**:

- 左側: 検索結果の表示（既存の`search-results.tsx`を改良）
- 右側上部: コンパクトな検索フォーム
- 右側下部: 保存済みパターンのクイックアクセス

## 3. コンポーネント設計

### 3.1 ディレクトリ構造

```md
app/(main)/search/
├── page.tsx                        # パターン一覧画面
├── create/
│   └── page.tsx                   # 新規作成画面
├── [searchId]/
│   ├── page.tsx                   # 検索実行画面
│   ├── layout.tsx                 # プロバイダー設定
│   └── components/
│       ├── search-layout.tsx      # 全体レイアウト管理
│       ├── search-results.tsx     # 検索結果表示（改良版）
│       ├── search-sidebar.tsx     # 右サイドバー全体
│       ├── compact-search-form.tsx # コンパクト検索フォーム
│       ├── pattern-cards.tsx      # 保存パターンカード一覧
│       └── modals/
│           ├── pattern-edit-modal.tsx
│           └── pattern-delete-modal.tsx
└── components/
    ├── pattern-card.tsx           # パターンカード（共通）
    ├── pattern-grid.tsx           # パターングリッド（一覧用）
    └── empty-state.tsx            # 空状態の表示
```

### 3.2 主要コンポーネントの責務

#### PatternCard

- 検索パターンの情報表示
- クリックで検索実行
- 使用回数、最終使用日時の表示

#### CompactSearchForm

- 最小限のフィールド表示
- 顧客名、住所、検索期間を常時表示
- 詳細オプション（追加キーワード、サイト指定）は折りたたみ式

#### SearchResults

- 検索結果のリスト表示
- ページネーション機能
- エラーハンドリング
- ローディング状態

#### PatternCards

- サイドバーでのパターン一覧表示
- クリックで即座に検索実行
- 現在の顧客名・住所は維持

### 3.3 データフロー

```typescript
// Context構造
SearchProvider
├── SearchPatternContext    // パターンの管理
│   ├── patterns[]         // 保存パターン一覧
│   ├── currentPattern     // 現在のパターン
│   └── actions           // CRUD操作
├── SearchFormContext      // フォーム状態
│   ├── formData          // 現在の入力値
│   └── updateField       // フィールド更新
└── SearchResultContext    // 検索結果
    ├── results           // 検索結果データ
    ├── loading          // ローディング状態
    └── error            // エラー状態
```

## 4. UI/UX仕様

### 4.1 デザインシステム

- **ベース**: Vercel風のミニマルデザイン
- **カラー**: モノクロームベース（黒・白・グレー）
- **タイポグラフィ**: Geist Sans/Mono
- **スペーシング**: Tailwindのデフォルトスケール
- **コンポーネント**: shadcn/ui

### 4.2 レスポンシブ対応

```md
- モバイル (< 768px): サイドバー非表示、検索フォームは別画面
- タブレット (768px - 1024px): サイドバー表示、2カラムレイアウト
- デスクトップ (> 1024px): フル3カラムレイアウト
```

### 4.3 インタラクション設計

#### パターンカードのクリック

1. カードをクリック
2. 現在の顧客名・住所は維持
3. その他の検索条件をパターンから適用
4. 自動的に検索実行
5. 結果を左側に表示

#### 検索フォームの操作

1. 顧客名入力（必須）
2. 住所入力（任意）
3. 検索期間選択（任意 - デフォルト：すべての期間）
4. 高度なオプション展開（任意）
   - 追加キーワード（OR検索）
   - サイト指定
5. 検索ボタンクリック
6. 結果表示とフォームのコンパクト化

### 4.4 パフォーマンス最適化

- 検索結果の仮想スクロール（大量結果対応）
- パターンカードの遅延読み込み
- 検索のデバウンス処理
- 結果のキャッシング

## 5. 実装優先順位

### Phase 1: 基盤構築

1. データベーススキーマの実装
2. 基本的なページ構造の作成
3. Context/Providerの設計

### Phase 2: コア機能

1. 検索パターン一覧画面
2. 検索実行画面のレイアウト
3. コンパクト検索フォーム

### Phase 3: 機能拡張

1. パターンのCRUD操作
2. 検索履歴の記録
3. API使用状況の可視化

### Phase 4: 最適化

1. パフォーマンス改善
2. UIの微調整
3. エラーハンドリングの強化

## 6. 検索フォームの仕様

### 6.1 簡素化された検索フィールド

#### 基本フィールド

- **顧客名**（必須）
  - 完全一致/部分一致の選択可能
- **住所**（任意）
  - 都道府県の個別選択は廃止、一つのテキストフィールドに統合
  - 完全一致/部分一致の選択可能
- **検索期間**（任意）
  - デフォルト：すべての期間
  - 選択肢：過去1年、3年、5年、10年

#### 高度な検索オプション（折りたたみ式）

- **追加キーワード**
  - OR検索のみ（AND/OR選択は廃止）
  - タグ形式で複数入力可能
- **検索対象サイト**
  - すべてのサイト/指定サイトのみ/指定サイトを除外

#### 廃止された機能

- 都道府県の個別選択フィールド
- 追加キーワードのAND/OR選択
- 除外キーワード機能全体

### 6.2 検索期間の実装

Google Custom Search APIの`dateRestrict`パラメータを使用：

- `''`（空文字）: すべての期間
- `'y1'`: 過去1年間
- `'y3'`: 過去3年間
- `'y5'`: 過去5年間
- `'y10'`: 過去10年間

## 7. 技術的考慮事項

### セキュリティ

- RLSによるユーザーデータの保護
- APIキーの適切な管理
- XSS対策（検索結果のサニタイズ）

### パフォーマンス

- 検索結果のページング（10件/ページ）
- インデックスの適切な設定
- 不要な再レンダリングの防止

### 保守性

- コンポーネントの単一責任原則
- 型定義の徹底
- テスタブルな設計
