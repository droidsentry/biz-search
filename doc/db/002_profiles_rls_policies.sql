-- =============================================
-- profilesテーブルのRLS（Row Level Security）ポリシー
-- =============================================
-- 
-- 目的: profilesテーブルへのアクセス制御
-- セキュリティ方針:
--   - 認証済みユーザーのみアクセス可能（匿名ユーザーは除外）
--   - ユーザーは自分のプロファイルのみ参照・更新可能
--   - プロファイルの作成は自分のIDでのみ可能
--   - 削除は不可（auth.usersの削除でカスケード削除）
-- 
-- パフォーマンス最適化:
--   - (SELECT auth.uid()) を使用して関数呼び出しをキャッシュ
--   - TO authenticated でロールを指定し、不要な評価を防ぐ
-- =============================================

-- RLSを有効化
ALTER TABLE public.profiles ENABLE ROW LEVEL SECURITY;

-- =============================================
-- SELECTポリシー
-- =============================================
-- 認証済みユーザーは自分のプロファイルのみ参照可能
CREATE POLICY "Users can view own profile" 
  ON public.profiles
  FOR SELECT 
  TO authenticated  -- 認証済みユーザーのみ
  USING ((SELECT auth.uid()) = id);  -- パフォーマンス最適化

-- =============================================
-- INSERTポリシー
-- =============================================
-- 新規ユーザー登録時のプロファイル作成を許可
-- 認証済みユーザーが自分のIDでのみ作成可能
CREATE POLICY "Users can insert own profile" 
  ON public.profiles
  FOR INSERT 
  TO authenticated  -- 認証済みユーザーのみ
  WITH CHECK ((SELECT auth.uid()) = id);  -- パフォーマンス最適化

-- =============================================
-- UPDATEポリシー
-- =============================================
-- 認証済みユーザーは自分のプロファイルのみ更新可能
CREATE POLICY "Users can update own profile" 
  ON public.profiles
  FOR UPDATE 
  TO authenticated  -- 認証済みユーザーのみ
  USING ((SELECT auth.uid()) = id)  -- パフォーマンス最適化
  WITH CHECK ((SELECT auth.uid()) = id);  -- パフォーマンス最適化

-- =============================================
-- DELETEポリシー
-- =============================================
-- プロファイルの直接削除は不可
-- auth.usersテーブルからの削除時にカスケード削除される
-- DELETEポリシーは意図的に作成しない

-- =============================================
-- 管理者用ポリシー（オプション）
-- =============================================
-- サービスロールは全ての操作が可能（RLSをバイパス）
-- これは自動的に適用されるため、明示的なポリシーは不要

-- =============================================
-- ポリシーの確認用クエリ
-- =============================================
-- 以下のクエリで設定されたポリシーを確認できます：
-- SELECT * FROM pg_policies WHERE tablename = 'profiles';